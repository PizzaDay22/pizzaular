<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PizzaDayToken Snake - Full Version</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {margin:0; background:#111; color:white; font-family:Arial, sans-serif; display:flex; flex-direction:column; align-items:center; padding:10px;}
#loginScreen {text-align:center; margin-bottom:20px;}
button {margin:5px; padding:10px 15px; cursor:pointer; background:orange; border:none; color:white; border-radius:5px; font-size:16px;}
#startBtn {background:green;}
.main-container {display:flex; flex-direction:row; gap:20px; flex-wrap:wrap; justify-content:center;}
.game-container {position:relative; max-width:600px;}
canvas {background:#222; border:3px solid orange; display:block; width:100%; height:auto;}
.controls {display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; justify-content:center;}
.arrow-btn {width:60px; height:60px; background:orange; border:none; color:white; font-size:24px; border-radius:50%; cursor:pointer; display:flex; justify-content:center; align-items:center; font-weight:bold; transition:0.1s;}
.arrow-btn:hover {background:#ff9900; transform:scale(1.1);}
.info-bar {text-align:center; margin-bottom:10px; color:white;}
.leaderboard {min-width:200px; max-width:250px;}
.leaderboard h2 {margin-bottom:5px;}
.leaderboard ol {padding-left:20px;}
input[type="text"]{padding:5px; width:180px; border-radius:5px; border:none;}
</style>
</head>
<body>

<!-- Login / Connect Wallet -->
<div id="loginScreen">
  <h2>üîë Connect Wallet</h2>
  <input type="text" id="playerName" placeholder="Masukkan nama / wallet">
  <br><br>
  <button id="loginBtn">Connect Wallet & Play</button>
</div>

<!-- Main Game + Leaderboard -->
<div class="main-container" style="display:none;" id="mainContainer">
  <div class="game-container" id="gameContainer">
    <h1>üçï PizzaDayToken Snake</h1>
    <div class="info-bar">Score: <span id="score">0</span> | Level: <span id="level">1</span> | Tokens: <span id="tokens">0</span></div>
    <canvas id="game" width="600" height="600"></canvas>
    <button id="startBtn" onclick="startGame()">Start Game</button>

    <div class="controls">
      <button class="arrow-btn" onclick="setDirection('UP')">‚¨Ü</button>
      <button class="arrow-btn" onclick="setDirection('LEFT')">‚¨Ö</button>
      <button class="arrow-btn" onclick="setDirection('DOWN')">‚¨á</button>
      <button class="arrow-btn" onclick="setDirection('RIGHT')">‚û°</button>
    </div>
  </div>

  <div class="leaderboard">
    <h2>Leaderboard</h2>
    <ol id="leaderboardList"></ol>
    <button onclick="convertPointsToTokens()">Tukar Poin ‚Üí Token</button>
  </div>
</div>

<audio id="eatSound" src="https://www.soundjay.com/button/sounds/button-16.mp3" preload="auto"></audio>
<audio id="dieSound" src="https://www.soundjay.com/button/sounds/button-10.mp3" preload="auto"></audio>
<audio id="bgMusic" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" loop autoplay></audio>

<script>
// --- Login ---
let playerName="";
document.getElementById("loginBtn").addEventListener("click", ()=>{
  const inputName=document.getElementById("playerName").value.trim();
  if(!inputName){ alert("Masukkan nama atau wallet!"); return; }
  playerName=inputName;
  document.getElementById("loginScreen").style.display="none";
  document.getElementById("mainContainer").style.display="flex";
});

// --- Snake Game ---
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
const box=20;
const pizzaSize=30; // pizza lebih kecil sekarang

let snake, food, score, direction, speed, game, level;
let mouthOpen=false;
let tokens=0;

// Leaderboard
let leaderboard=JSON.parse(localStorage.getItem("pdtLeaderboard") || "[]");
updateLeaderboardDisplay();

function startGame(){
  snake=[{x:300,y:300}];
  food=randomFood();
  score=0; level=1; direction="RIGHT"; speed=500; mouthOpen=false;
  document.getElementById("score").innerText=score;
  document.getElementById("level").innerText=level;
  document.getElementById("tokens").innerText=tokens;
  document.getElementById("bgMusic").volume=0.3;
  document.getElementById("bgMusic").play();
  clearInterval(game);
  game=setInterval(draw,speed);
}

function setDirection(dir){
  if(dir==="LEFT" && direction!=="RIGHT") direction="LEFT";
  if(dir==="UP" && direction!=="DOWN") direction="UP";
  if(dir==="RIGHT" && direction!=="LEFT") direction="RIGHT";
  if(dir==="DOWN" && direction!=="UP") direction="DOWN";
}

window.addEventListener("keydown", e=>{
  if(["ArrowLeft","ArrowUp","ArrowRight","ArrowDown"].includes(e.key)) e.preventDefault();
  if(e.key==="ArrowLeft"&&direction!=="RIGHT") direction="LEFT";
  if(e.key==="ArrowUp"&&direction!=="DOWN") direction="UP";
  if(e.key==="ArrowRight"&&direction!=="LEFT") direction="RIGHT";
  if(e.key==="ArrowDown"&&direction!=="UP") direction="DOWN";
});

// Mobile swipe
let touchStartX=0, touchStartY=0;
canvas.addEventListener("touchstart", e=>{ const t=e.touches[0]; touchStartX=t.clientX; touchStartY=t.clientY; });
canvas.addEventListener("touchend", e=>{
  const t=e.changedTouches[0];
  const dx=t.clientX-touchStartX, dy=t.clientY-touchStartY;
  if(Math.abs(dx)>Math.abs(dy)){
    if(dx>0) setDirection("RIGHT"); else setDirection("LEFT");
  }else{
    if(dy>0) setDirection("DOWN"); else setDirection("UP");
  }
});

function randomFood(){
  const maxX=canvas.width/box; const maxY=canvas.height/box;
  return {x:Math.floor(Math.random()*maxX)*box, y:Math.floor(Math.random()*maxY)*box};
}

function draw(){
  ctx.fillStyle="#222"; ctx.fillRect(0,0,canvas.width,canvas.height);

  for(let i=1;i<snake.length;i++){ ctx.fillStyle="green"; ctx.fillRect(snake[i].x,snake[i].y,box,box); }

  ctx.font=box+"px Arial"; const headEmoji=mouthOpen?"üòã":"üßë";
  ctx.fillText(headEmoji,snake[0].x+2,snake[0].y+box-2);

  ctx.font=pizzaSize+"px Arial"; ctx.fillText("üçï",food.x+2,food.y+pizzaSize-10);

  let headX=snake[0].x, headY=snake[0].y;
  if(direction==="LEFT") headX-=box;
  if(direction==="UP") headY-=box;
  if(direction==="RIGHT") headX+=box;
  if(direction==="DOWN") headY+=box;

  if(headX<0||headX>=canvas.width||headY<0||headY>=canvas.height||snake.some(seg=>seg.x===headX&&seg.y===headY)){
    clearInterval(game); document.getElementById("dieSound").play();
    alert("Game Over! Score: "+score);
    if(score>=100){ saveScore(score); updateLeaderboardDisplay(); }
    return;
  }

  snake.unshift({x:headX,y:headY});

  if(headX===food.x && headY===food.y){
    score+=10;
    document.getElementById("score").innerText=score;
    food=randomFood(); mouthOpen=true; document.getElementById("eatSound").play();
    if(speed>80){ speed-=5; clearInterval(game); game=setInterval(draw,speed); }
    if(score%50===0){ level+=1; document.getElementById("level").innerText=level; }
    setTimeout(()=>{ mouthOpen=false; },200);
  }else{ mouthOpen=false; snake.pop(); }

  if(score>=100){ saveScore(score); updateLeaderboardDisplay(); }
}

// --- Leaderboard & Token ---
function saveScore(score){
  const entryIndex=leaderboard.findIndex(e=>e.name===playerName);
  if(entryIndex>=0){
    if(score>leaderboard[entryIndex].score){ leaderboard[entryIndex].score=score; leaderboard[entryIndex].date=new Date().toISOString(); }
  }else{ leaderboard.push({name:playerName,score, date:new Date().toISOString()}); }
  leaderboard.sort((a,b)=>b.score-a.score);
  if(leaderboard.length>10) leaderboard=leaderboard.slice(0,10);
  localStorage.setItem("pdtLeaderboard",JSON.stringify(leaderboard));
}

function updateLeaderboardDisplay(){
  const list=document.getElementById("leaderboardList");
  list.innerHTML="";
  leaderboard.forEach(item=>{ list.innerHTML+=`<li>${item.name} ‚Äî ${item.score} pts</li>`; });
}

function convertPointsToTokens(){
  if(score>=100){
    const earnedTokens=(score/100)*0.1;
    tokens+=earnedTokens;
    score=0;
    document.getElementById("tokens").innerText=tokens.toFixed(1);
    document.getElementById("score").innerText=score;
    alert(`Selamat! Kamu mendapatkan ${earnedTokens.toFixed(1)} PizzadayToken!`);
  }else{
    alert("Poin belum cukup untuk ditukar. (Minimal 100 poin = 0.1 token)");
  }
}
</script>
</body>
</html>
